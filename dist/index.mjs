import{atom as e,getter as t,setter as o,useGlobalValue as a}from"elum-state";import p from"@vkontakte/vk-bridge";import{useState as r,useEffect as n}from"react";const s=(e,t)=>Object.keys(e).every((o=>e[o]===t[o]||"[object Object]"===Object.prototype.toString.call(e[o])&&s(e[o],t[o]))),l={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},i={},c=e({key:"router_active_app"}),u=e({key:"router_active_view"}),m=e({key:"router_active_panel"}),y=e({key:"router_active_modal"}),d=e({key:"router_active_popout"}),f=e({key:"router_active_notify"}),v=e({key:"router_active_params"}),w=["app","view","panel","modal","popout"],h=e=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(c),p=e.app||a,r=t(u),n=e.view||r,f=!i[p]?.[n];f&&(i[p]||(i[p]={}),i[p][n]||(i[p][n]=[l]));const h=i[p][n],k=h[h.length-1],b={panel:e.panel||k.panel,modal:e.modal||k.modal,popout:e.popout||k.popout,stay:e.stay||l.stay,freeze:e.freeze||l.freeze,params:e.params||k.params};for(let t=w.length-1;t>=0;t--){const o=w[t];if(e[o])break;b[o]=l[o]}const _=s(k,b);!_&&h.push(b),a===p&&r===n&&!f&&_||(o(c,p),o(u,n),o(m,b.panel),o(y,b.modal),o(d,b.popout),o(v,b.params)),e.clear&&r!==n&&(i[p][r]=[l])},k=(e={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(c),r=t(u),n=i[a][r],s=n[n.length-1],l=((e,t)=>{const o=typeof e;if("boolean"===o&&!e)return t.length-2;let a=0;for(let p=t.length-1;p>0;p--){const r=t[p];if("boolean"===o&&r.stay||r.stay===e){a=p;break}}return a})(e.toStay||!1,n),f=n[l];if(1===n.length)return void p.send("VKWebAppClose",{status:"success"});if(s.freeze&&!e.ignoreFreeze)return;n.splice(l+1);const w={panel:f.panel,modal:f.modal,popout:f.popout,stay:f.stay,freeze:f.freeze,params:f.params};o(u,r),o(m,w.panel),o(y,w.modal),o(d,w.popout),o(v,w.params)};function b(e,t,a,p){return p?function(e,t,a,p){const r=()=>(o(f,void 0),p);o(f,{type:e,params:a,callback:r}),t&&setTimeout((()=>{r()({type:e,params:a})}),t)}(e,t,a,p):function(e,t,a){return new Promise((p=>{const r=()=>(o(f,void 0),p);o(f,{type:e,params:a,callback:r}),t&&setTimeout((()=>{r()({type:e,params:a})}),t)}))}(e,t,a)}function _(e){try{const a=t(f);return(!e||a.type===e)&&(o(f,void 0),a.callback({type:a.type,params:a.params}),!0)}catch{return!1}}const g=()=>{const[e]=r(t(v));return e},z={app:c,view:u,panel:m,modal:y,popout:d},S=e=>a(z[e]),j=()=>{const e=a(f);return e?{type:e.type,params:e.params}:{type:void 0,params:{}}},O=({app:e="web",branch:o,children:a})=>(t(u)&&t(c)||h({app:e,view:o}),n((()=>{window.addEventListener("popstate",(()=>k())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a);export{O as Router,k as backPage,_ as hideNotify,h as nextPage,b as showNotify,j as useNotify,g as useParams,S as useRouter};
