import{atom as t,getter as e,setter as r,useGlobalValue as o}from"elum-state";import a from"@vkontakte/vk-bridge";import{useState as n,useRef as p,useEffect as s}from"react";const i={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},u={},c=t({key:"router_active_app"}),l=t({key:"router_active_view"}),f=t({key:"router_active_panel"}),y=t({key:"router_active_modal"}),m=t({key:"router_active_popout"}),v=t({key:"router_active_notify"}),d=t({key:"router_active_params"}),_=(t,e)=>{if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){if(t.constructor!==e.constructor)return!1;var r,o,a;if(Array.isArray(t)){if((r=t.length)!=e.length)return!1;for(o=r;0!=o--;)if(!_(t[o],e[o]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();if((r=(a=Object.keys(t)).length)!==Object.keys(e).length)return!1;for(o=r;0!=o--;)if(!Object.prototype.hasOwnProperty.call(e,a[o]))return!1;for(o=r;0!=o--;){var n=a[o];if(!_(t[n],e[n]))return!1}return!0}return t!=t&&e!=e},h=["popout","modal","panel"],w=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e(c),a=t.app,n=a||o,p=!(!a||a===o),s=u[n]?.__snapshot,v=p&&Array.isArray(s)?s[0].view:e(l),w=t.view||v;!u[n]?.[w]&&(u[n]||(u[n]={__snapshot:[]}),u[n][w]||(u[n][w]=[i])),Array.isArray(u[n]?.__snapshot)||(u[n].__snapshot=[]);const g=p&&Array.isArray(s)?s[0]:u[n][w].at(-1),b={panel:t.panel||g.panel,modal:t.modal||g.modal,popout:t.popout||g.popout,stay:t.stay||i.stay,freeze:t.freeze||i.freeze,params:t.params||g.params};if(!p)for(let e of h){if(t[e])break;b[e]=i[e]}_(u[n][w].at(-1),b)||u[n][w].push(b),u[n].__snapshot=[{view:w,...b}],r(c,n),r(l,w),r(f,b.panel),r(y,b.modal),r(m,b.popout),r(d,b.params),t.clear&&v!==w&&(u[n].__snapshot=[i],u[n][v]=[i])},g=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e(c),n=e(l),p=u[o][n],s=((t,e)=>{const r=typeof t;if("boolean"===r&&!t)return e.length-2;const o="boolean"===r?Boolean:String;for(let r=e.length-1;r>0;r--)if(o(e[r].stay)===t)return r;return 0})(t.toStay||!1,p);if(1===p.length)return void a.send("VKWebAppClose",{status:"success"});const i=p.at(-1);i&&i.freeze&&!t.ignoreFreeze||(u[o].__snapshot=[{view:n,...p[s]}],r(c,o),r(l,n),r(f,p[s].panel),r(y,p[s].modal),r(m,p[s].popout),r(d,p[s].params),p.splice(s+1))};function b(t,e,o,a){return a?function(t,e,o,a){const n=()=>(r(v,void 0),a);r(v,{type:t,params:o,callback:n}),e&&setTimeout((()=>{n()({type:t,params:o})}),e)}(t,e,o,a):function(t,e,o){return new Promise((a=>{const n=()=>(r(v,void 0),a);r(v,{type:t,params:o,callback:n}),e&&setTimeout((()=>{n()({type:t,params:o})}),e)}))}(t,e,o)}function k(t){try{const o=e(v);return(!t||o.type===t)&&(r(v,void 0),o.callback({type:o.type,params:o.params}),!0)}catch{return!1}}const O=()=>{const[t]=n(e(d));return t},S={app:c,view:l,panel:f,modal:y,popout:m},A=t=>{const r=p(e(c)).current,a=o(S[t]),[i,u]=n(a);return s((()=>{"app"!==t&&e(c)!==r||u(a)}),[a]),i},j=()=>{const t=o(v);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},z=({app:t="web",branch:r,children:o})=>(e(l)&&e(c)||w({app:t,view:r}),s((()=>{window.addEventListener("popstate",(()=>g())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),o);export{c as ACTIVE_APP,y as ACTIVE_MODAL,v as ACTIVE_NOTIFY,f as ACTIVE_PANEL,d as ACTIVE_PARAMS,m as ACTIVE_POPOUT,l as ACTIVE_VIEW,z as Router,g as backPage,k as hideNotify,w as nextPage,b as showNotify,j as useNotify,O as useParams,A as useRouter};
