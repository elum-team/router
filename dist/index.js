"use strict";var e=require("elum-state"),t=require("@vkontakte/vk-bridge"),o=require("react");const r=(e,t)=>Object.keys(e).every((o=>e[o]===t[o]||"[object Object]"===Object.prototype.toString.call(e[o])&&r(e[o],t[o]))),a={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},s={},p=e.atom({key:"router_active_app"}),n=e.atom({key:"router_active_view"}),l=e.atom({key:"router_active_panel"}),i=e.atom({key:"router_active_modal"}),u=e.atom({key:"router_active_popout"}),c=e.atom({key:"router_active_notify"}),m=e.atom({key:"router_active_params"}),y=["app","view","panel","modal","popout"],d=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(p),c=t.app||o,d=e.getter(n),f=t.view||d,v=!s[c]?.[f];v&&(s[c]||(s[c]={}),s[c][f]||(s[c][f]=[a]));const w=s[c][f],g=w[w.length-1],h={panel:t.panel||g.panel,modal:t.modal||g.modal,popout:t.popout||g.popout,stay:t.stay||a.stay,freeze:t.freeze||a.freeze,params:t.params||g.params};for(let e=y.length-1;e>=0;e--){const o=y[e];if(t[o])break;h[o]=a[o]}const b=r(g,h);!b&&w.push(h),o===c&&d===f&&!v&&b||(e.setter(p,c),e.setter(n,f),e.setter(l,h.panel),e.setter(i,h.modal),e.setter(u,h.popout),e.setter(m,h.params)),t.clear&&d!==f&&(s[c][d]=[a])},f=(o={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e.getter(p),a=e.getter(n),c=s[r][a],y=c[c.length-1],d=((e,t)=>{const o=typeof e;if("boolean"===o&&!e)return t.length-2;let r=0;for(let a=t.length-1;a>0;a--){const s=t[a];if("boolean"===o&&s.stay||s.stay===e){r=a;break}}return r})(o.toStay||!1,c),f=c[d];if(1===c.length)return void t.send("VKWebAppClose",{status:"success"});if(y.freeze&&!o.ignoreFreeze)return;c.splice(d+1);const v={panel:f.panel,modal:f.modal,popout:f.popout,stay:f.stay,freeze:f.freeze,params:f.params};e.setter(n,a),e.setter(l,v.panel),e.setter(i,v.modal),e.setter(u,v.popout),e.setter(m,v.params)};const v={app:p,view:n,panel:l,modal:i,popout:u};exports.Router=({branch:t,children:r})=>(e.getter(n)||d({view:t}),o.useEffect((()=>{window.addEventListener("popstate",(()=>f())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),o.createElement(o.Fragment,null,r)),exports.backPage=f,exports.hideNotify=function(t){try{const o=e.getter(c);return(!t||o.type===t)&&(e.setter(c,void 0),o.callback({type:o.type,params:o.params}),!0)}catch{return!1}},exports.nextPage=d,exports.showNotify=function(t,o,r,a){return a?function(t,o,r,a){const s=()=>(e.setter(c,void 0),a);e.setter(c,{type:t,params:r,callback:s}),o&&setTimeout((()=>{s()({type:t,params:r})}),o)}(t,o,r,a):function(t,o,r){return new Promise((a=>{const s=()=>(e.setter(c,void 0),a);e.setter(c,{type:t,params:r,callback:s}),o&&setTimeout((()=>{s()({type:t,params:r})}),o)}))}(t,o,r)},exports.useNotify=()=>{const t=e.useGlobalValue(c);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=o.useState(e.getter(m));return t},exports.useRouter=t=>e.useGlobalValue(v[t]);
