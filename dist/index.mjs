import{atom as e,getter as t,setter as o,useGlobalValue as a}from"elum-state";import r from"@vkontakte/vk-bridge";import p,{useState as n,useEffect as l,Fragment as s}from"react";const i=(e,t)=>Object.keys(e).every((o=>e[o]===t[o]||"[object Object]"===Object.prototype.toString.call(e[o])&&i(e[o],t[o]))),c={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},u={},m=e({key:"router_active_app"}),y=e({key:"router_active_view"}),d=e({key:"router_active_panel"}),f=e({key:"router_active_modal"}),v=e({key:"router_active_popout"}),w=e({key:"router_active_notify"}),h=e({key:"router_active_params"}),k=["app","view","panel","modal","popout"],b=e=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(m),r=e.app||a,p=t(y),n=e.view||p,l=!u[r]?.[n];l&&(u[r]||(u[r]={}),u[r][n]||(u[r][n]=[c]));const s=u[r][n],w=s[s.length-1],b={panel:e.panel||w.panel,modal:e.modal||w.modal,popout:e.popout||w.popout,stay:e.stay||c.stay,freeze:e.freeze||c.freeze,params:e.params||w.params};for(let t=k.length-1;t>=0;t--){const o=k[t];if(e[o])break;b[o]=c[o]}const _=i(w,b);!_&&s.push(b),a===r&&p===n&&!l&&_||(o(m,r),o(y,n),o(d,b.panel),o(f,b.modal),o(v,b.popout),o(h,b.params)),e.clear&&p!==n&&(u[r][p]=[c])},_=(e={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(m),p=t(y),n=u[a][p],l=n[n.length-1],s=((e,t)=>{const o=typeof e;if("boolean"===o&&!e)return t.length-2;let a=0;for(let r=t.length-1;r>0;r--){const p=t[r];if("boolean"===o&&p.stay||p.stay===e){a=r;break}}return a})(e.toStay||!1,n),i=n[s];if(1===n.length)return void r.send("VKWebAppClose",{status:"success"});if(l.freeze&&!e.ignoreFreeze)return;n.splice(s+1);const c={panel:i.panel,modal:i.modal,popout:i.popout,stay:i.stay,freeze:i.freeze,params:i.params};o(y,p),o(d,c.panel),o(f,c.modal),o(v,c.popout),o(h,c.params)};function g(e,t,a,r){return r?function(e,t,a,r){const p=()=>(o(w,void 0),r);o(w,{type:e,params:a,callback:p}),t&&setTimeout((()=>{p()({type:e,params:a})}),t)}(e,t,a,r):function(e,t,a){return new Promise((r=>{const p=()=>(o(w,void 0),r);o(w,{type:e,params:a,callback:p}),t&&setTimeout((()=>{p()({type:e,params:a})}),t)}))}(e,t,a)}function z(e){try{const a=t(w);return(!e||a.type===e)&&(o(w,void 0),a.callback({type:a.type,params:a.params}),!0)}catch{return!1}}const S=()=>{const[e]=n(t(h));return e},j={app:m,view:y,panel:d,modal:f,popout:v},O=e=>a(j[e]),E=()=>{const e=a(w);return e?{type:e.type,params:e.params}:{type:void 0,params:{}}},F=({branch:e,children:o})=>(t(y)||b({view:e}),l((()=>{window.addEventListener("popstate",(()=>_())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),p.createElement(s,null,o));export{F as Router,_ as backPage,z as hideNotify,b as nextPage,g as showNotify,E as useNotify,S as useParams,O as useRouter};
