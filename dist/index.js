"use strict";var e=require("elum-state"),t=require("@vkontakte/vk-bridge"),r=require("react");const o={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},a={},s=e.atom({key:"router_active_app"}),p=e.atom({key:"router_active_view"}),n=e.atom({key:"router_active_panel"}),i=e.atom({key:"router_active_modal"}),u=e.atom({key:"router_active_popout"}),l=e.atom({key:"router_active_notify"}),c=e.atom({key:"router_active_params"}),f=(e,t,r=[])=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;var o,a,s;if(Array.isArray(e)){if((o=e.length)!=t.length)return!1;for(a=o;0!=a--;)if(!f(e[a],t[a]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if((o=(s=Object.keys(e)).length)!==Object.keys(t).length)return!1;for(a=o;0!=a--;){var p=s[a];if(!r.includes(p)){if(!Object.prototype.hasOwnProperty.call(t,p))return!1;if(!f(e[p],t[p]))return!1}}return!0}return e!=e&&t!=t},y=["popout","modal","panel"],m=(t,r)=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const l=e.getter(s),m=t.app,_=m||l,d=!(!m||m===l),v=a[_]?.__snapshot,g=d&&Array.isArray(v)?v[0].view:e.getter(p),h=t.view||g;!a[_]?.[h]&&(a[_]||(a[_]={__snapshot:[]}),a[_][h]||(a[_][h]=[o])),Array.isArray(a[_]?.__snapshot)||(a[_].__snapshot=[]);const w=d&&Array.isArray(v)?v[0]:a[_][h].at(-1),A={panel:t.panel||w.panel,modal:t.modal||w.modal,popout:t.popout||w.popout,stay:t.stay||o.stay,freeze:t.freeze||o.freeze,params:t.params||w.params};if(!d)for(let e of y){if(t[e])break;A[e]=o[e]}f(a[_][h].at(-1),A,r||[])||a[_][h].push(A),a[_].__snapshot=[{view:h,...A}],e.setter(s,_),e.setter(p,h),e.setter(n,A.panel),e.setter(i,A.modal),e.setter(u,A.popout),e.setter(c,A.params),t.clear&&g!==h&&(a[_].__snapshot=[o],a[_][g]=[o])},_=(r={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(s),l=e.getter(p),f=a[o][l],y=((e,t)=>{const r=typeof e;if("boolean"===r&&!e)return t.length-2;const o="boolean"===r?Boolean:String;for(let r=t.length-1;r>0;r--)if(o(t[r].stay)===e)return r;return 0})(r.toStay||!1,f);if(1===f.length)return void t.send("VKWebAppClose",{status:"success"});const m=f.at(-1);m&&m.freeze&&!r.ignoreFreeze||(a[o].__snapshot=[{view:l,...f[y]}],e.setter(s,o),e.setter(p,l),e.setter(n,f[y].panel),e.setter(i,f[y].modal),e.setter(u,f[y].popout),e.setter(c,f[y].params),f.splice(y+1))};const d={app:s,view:p,panel:n,modal:i,popout:u};exports.ACTIVE_APP=s,exports.ACTIVE_MODAL=i,exports.ACTIVE_NOTIFY=l,exports.ACTIVE_PANEL=n,exports.ACTIVE_PARAMS=c,exports.ACTIVE_POPOUT=u,exports.ACTIVE_VIEW=p,exports.Router=({app:t="web",branch:o,children:a})=>(e.getter(p)&&e.getter(s)||m({app:t,view:o}),r.useEffect((()=>{window.addEventListener("popstate",(()=>_())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a),exports.backPage=_,exports.hideNotify=function(t){try{const r=e.getter(l);return(!t||r.type===t)&&(e.setter(l,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}},exports.nextPage=m,exports.showNotify=function(t,r,o,a){return a?function(t,r,o,a){const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}(t,r,o,a):function(t,r,o){return new Promise((a=>{const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}))}(t,r,o)},exports.useNotify=()=>{const t=e.useGlobalValue(l);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=r.useState(e.getter(c));return t},exports.useRouter=t=>{const o=r.useRef(e.getter(s)).current,a=e.useGlobalValue(d[t]),[p,n]=r.useState(a);return r.useEffect((()=>{"app"!==t&&e.getter(s)!==o||n(a)}),[a]),p};
