import{atom as e,getter as o,setter as t,useGlobalValue as a}from"elum-state";import r from"@vkontakte/vk-bridge";import p,{useState as l,Fragment as n}from"react";import{ACTIVE_VIEW as s}from"atoms";const i={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},c={},m=e({key:"router_active_view"}),u=e({key:"router_active_panel"}),d=e({key:"router_active_modal"}),f=e({key:"router_active_popout"}),y=e({key:"router_active_params"}),v=(e,o)=>Object.keys(e).every((t=>e[t]===o[t]||"[object Object]"===Object.prototype.toString.call(e[t])&&v(e[t],o[t]))),h=["view","panel","modal","popout"],w=e=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=o(m),r=e.view||a,p=!c[r];p&&(c[r]=[i]);const l=c[r],n=l[l.length-1],s={panel:e.panel||n.panel,modal:e.modal||n.modal,popout:e.popout||n.popout,stay:e.stay||i.stay,freeze:e.freeze||i.freeze,params:e.params||n.params};for(let o=h.length-1;o>=0;o--){const t=h[o];if(e[t])break;s[t]=i[t]}const w=v(n,s);w||l.push(s),a===r&&!p&&w||(t(m,r),t(u,s.panel),t(d,s.modal),t(f,s.popout),t(y,s.params)),e.clear&&a!==r&&(c[a]=[i])},b=(e={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=o(m),p=c[a],l=p[p.length-1],n=((e,o)=>{const t=typeof e;if("boolean"===t&&!e)return o.length-2;let a=0;for(let r=o.length-1;r>0;r--){const p=o[r];if("boolean"===t&&p.stay||p.stay===e){a=r;break}}return a})(e.toStay||!1,p),s=p[n];if(1===p.length)return void r.send("VKWebAppClose",{status:"success"});if(l.freeze&&!e.ignoreFreeze)return;p.splice(n+1);const i={panel:s.panel,modal:s.modal,popout:s.popout,stay:s.stay,freeze:s.freeze,params:s.params};t(m,a),t(u,i.panel),t(d,i.modal),t(f,i.popout),t(y,i.params)},k=()=>{const[e]=l(o(y));return e},_={view:m,panel:u,modal:d,popout:f},g=e=>a(_[e]),z=({branch:e,children:t})=>(o(s)||w({view:e}),p.createElement(n,null,t));export{z as Router,b as backPage,w as nextPage,k as useParams,g as useRouter};
