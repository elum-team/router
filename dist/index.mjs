import{atom as e,getter as t,setter as o,useGlobalValue as a}from"elum-state";import r from"@vkontakte/vk-bridge";import{useState as p,useRef as n,useEffect as s}from"react";const c=(e,t)=>Object.keys(e).every((o=>{const a=Object.prototype.toString.call(e[o]);if(a!=Object.prototype.toString.call(t[o]))return!1;switch(a){case"[object String]":case"[object Number]":case"[object Boolean]":return e[o]===t[o];case"[object Object]":case"[object Array]":return c(e[o],t[o]);default:return!1}})),l={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},i={},u=e({key:"router_active_app"}),m=e({key:"router_active_view"}),y=e({key:"router_active_panel"}),d=e({key:"router_active_modal"}),f=e({key:"router_active_popout"}),v=e({key:"router_active_notify"}),w=e({key:"router_active_params"}),b=["app","view","panel","modal","popout"],h=e=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(u),r=e.app||a,p=t(m),n=e.view||p,s=!i[r]?.[n];s&&(i[r]||(i[r]={}),i[r][n]||(i[r][n]=[l]));const v=i[r][n],h=v[v.length-1],k={panel:e.panel||h.panel,modal:e.modal||h.modal,popout:e.popout||h.popout,stay:e.stay||l.stay,freeze:e.freeze||l.freeze,params:e.params||h.params};for(let t=b.length-1;t>=0;t--){const o=b[t];if(e[o])break;k[o]=l[o]}const _=c(h,k);!_&&v.push(k),a===r&&p===n&&!s&&_||(o(u,r),o(m,n),o(y,k.panel),o(d,k.modal),o(f,k.popout),o(w,k.params)),e.clear&&p!==n&&(i[r][p]=[l])},k=(e={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=t(u),p=t(m),n=i[a][p],s=n[n.length-1],c=((e,t)=>{const o=typeof e;if("boolean"===o&&!e)return t.length-2;let a=0;for(let r=t.length-1;r>0;r--){const p=t[r];if("boolean"===o&&p.stay||p.stay===e){a=r;break}}return a})(e.toStay||!1,n),l=n[c];if(1===n.length)return void r.send("VKWebAppClose",{status:"success"});if(s.freeze&&!e.ignoreFreeze)return;n.splice(c+1);const v={panel:l.panel,modal:l.modal,popout:l.popout,stay:l.stay,freeze:l.freeze,params:l.params};o(m,p),o(y,v.panel),o(d,v.modal),o(f,v.popout),o(w,v.params)};function _(e,t,a,r){return r?function(e,t,a,r){const p=()=>(o(v,void 0),r);o(v,{type:e,params:a,callback:p}),t&&setTimeout((()=>{p()({type:e,params:a})}),t)}(e,t,a,r):function(e,t,a){return new Promise((r=>{const p=()=>(o(v,void 0),r);o(v,{type:e,params:a,callback:p}),t&&setTimeout((()=>{p()({type:e,params:a})}),t)}))}(e,t,a)}function g(e){try{const a=t(v);return(!e||a.type===e)&&(o(v,void 0),a.callback({type:a.type,params:a.params}),!0)}catch{return!1}}const j=()=>{const[e]=p(t(w));return e},z={app:u,view:m,panel:y,modal:d,popout:f},S=e=>{const o=n(t(u)).current,r=a(z[e]),[c,l]=p(r);return s((()=>{"app"!==e&&t(u)!==o||l(r)}),[r]),c},O=()=>{const e=a(v);return e?{type:e.type,params:e.params}:{type:void 0,params:{}}},A=({app:e="web",branch:o,children:a})=>(t(m)&&t(u)||h({app:e,view:o}),s((()=>{window.addEventListener("popstate",(()=>k())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a);export{u as ACTIVE_APP,d as ACTIVE_MODAL,v as ACTIVE_NOTIFY,y as ACTIVE_PANEL,w as ACTIVE_PARAMS,f as ACTIVE_POPOUT,m as ACTIVE_VIEW,A as Router,k as backPage,g as hideNotify,h as nextPage,_ as showNotify,O as useNotify,j as useParams,S as useRouter};
