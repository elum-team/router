"use strict";var e=require("elum-state"),t=require("@vkontakte/vk-bridge"),r=require("react");const o={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},a={},s=e.atom({key:"router_active_app"}),p=e.atom({key:"router_active_view"}),n=e.atom({key:"router_active_panel"}),i=e.atom({key:"router_active_modal"}),c=e.atom({key:"router_active_popout"}),u=e.atom({key:"router_active_notify"}),l=e.atom({key:"router_active_params"}),y=(e,t)=>Object.keys(e).every((r=>{const o=Object.prototype.toString.call(e[r]);if(o!=Object.prototype.toString.call(t[r]))return!1;switch(o){case"[object String]":case"[object Number]":case"[object Boolean]":return e[r]===t[r];case"[object Object]":case"[object Array]":return y(e[r],t[r]);default:return!1}})),m=["params","popout","modal","panel"],f=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e.getter(s),u=t.app,f=u||r,_=!(!u||u===r),d=a[f]?.__snapshot,v=_&&Array.isArray(d)?d[0].view:e.getter(p),w=t.view||v;!a[f]?.[w]&&(a[f]||(a[f]={__snapshot:[]}),a[f][w]||(a[f][w]=[o])),Array.isArray(a[f]?.__snapshot)||(a[f].__snapshot=[]);const b=_&&Array.isArray(d)?d[0]:a[f][w].at(-1),g={panel:t.panel||b.panel,modal:t.modal||b.modal,popout:t.popout||b.popout,stay:t.stay||o.stay,freeze:t.freeze||o.freeze,params:t.params||b.params};if(!_)for(let e of m){if(t[e])break;g[e]=o[e]}!y(a[f][w].at(-1)||[],g)&&a[f][w].push(g),a[f].__snapshot=[{view:w,...g}],e.setter(s,f),e.setter(p,w),e.setter(n,g.panel),e.setter(i,g.modal),e.setter(c,g.popout),e.setter(l,g.params),t.clear&&v!==w&&(a[f].__snapshot=[o],a[f][v]=[o])},_=(r={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(s),u=e.getter(p),y=a[o][u],m=((e,t)=>{const r=typeof e;if("boolean"===r&&!e)return t.length-2;const o="boolean"===r?Boolean:String;for(let r=t.length-1;r>0;r--)if(o(t[r].stay)===e)return r;return 0})(r.toStay||!1,y);if(1===y.length)return void t.send("VKWebAppClose",{status:"success"});const f=y.at(-1);f&&f.freeze&&!r.ignoreFreeze||(e.setter(s,o),e.setter(p,u),e.setter(n,y[m].panel),e.setter(i,y[m].modal),e.setter(c,y[m].popout),e.setter(l,y[m].params),y.splice(m+1))};const d={app:s,view:p,panel:n,modal:i,popout:c};exports.ACTIVE_APP=s,exports.ACTIVE_MODAL=i,exports.ACTIVE_NOTIFY=u,exports.ACTIVE_PANEL=n,exports.ACTIVE_PARAMS=l,exports.ACTIVE_POPOUT=c,exports.ACTIVE_VIEW=p,exports.Router=({app:t="web",branch:o,children:a})=>(e.getter(p)&&e.getter(s)||f({app:t,view:o}),r.useEffect((()=>{window.addEventListener("popstate",(()=>_())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a),exports.backPage=_,exports.hideNotify=function(t){try{const r=e.getter(u);return(!t||r.type===t)&&(e.setter(u,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}},exports.nextPage=f,exports.showNotify=function(t,r,o,a){return a?function(t,r,o,a){const s=()=>(e.setter(u,void 0),a);e.setter(u,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}(t,r,o,a):function(t,r,o){return new Promise((a=>{const s=()=>(e.setter(u,void 0),a);e.setter(u,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}))}(t,r,o)},exports.useNotify=()=>{const t=e.useGlobalValue(u);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=r.useState(e.getter(l));return t},exports.useRouter=t=>{const o=r.useRef(e.getter(s)).current,a=e.useGlobalValue(d[t]),[p,n]=r.useState(a);return r.useEffect((()=>{"app"!==t&&e.getter(s)!==o||n(a)}),[a]),p};
