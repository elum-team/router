"use strict";var e=require("elum-state"),t=require("@vkontakte/vk-bridge"),r=require("react");const o={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},a={},s=e.atom({key:"router_active_app"}),p=e.atom({key:"router_active_view"}),n=e.atom({key:"router_active_panel"}),i=e.atom({key:"router_active_modal"}),u=e.atom({key:"router_active_popout"}),l=e.atom({key:"router_active_notify"}),c=e.atom({key:"router_active_params"}),f=(e,t)=>{if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){if(e.constructor!==t.constructor)return!1;var r,o,a;if(Array.isArray(e)){if((r=e.length)!=t.length)return!1;for(o=r;0!=o--;)if(!f(e[o],t[o]))return!1;return!0}if(e.constructor===RegExp)return e.source===t.source&&e.flags===t.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===t.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===t.toString();if((r=(a=Object.keys(e)).length)!==Object.keys(t).length)return!1;for(o=r;0!=o--;){var s=a[o];if(!["stay","freeze","params"].includes(s)){if(!Object.prototype.hasOwnProperty.call(t,s))return!1;if(!f(e[s],t[s]))return!1}}return!0}return e!=e&&t!=t},y=["popout","modal","panel"],m=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const r=e.getter(s),l=t.app,m=l||r,_=!(!l||l===r),d=a[m]?.__snapshot,v=_&&Array.isArray(d)?d[0].view:e.getter(p),g=t.view||v;!a[m]?.[g]&&(a[m]||(a[m]={__snapshot:[]}),a[m][g]||(a[m][g]=[o])),Array.isArray(a[m]?.__snapshot)||(a[m].__snapshot=[]);const h=_&&Array.isArray(d)?d[0]:a[m][g].at(-1),w={panel:t.panel||h.panel,modal:t.modal||h.modal,popout:t.popout||h.popout,stay:t.stay||o.stay,freeze:t.freeze||o.freeze,params:t.params||h.params};if(!_)for(let e of y){if(t[e])break;w[e]=o[e]}f(a[m][g].at(-1),w)||a[m][g].push(w),a[m].__snapshot=[{view:g,...w}],e.setter(s,m),e.setter(p,g),e.setter(n,w.panel),e.setter(i,w.modal),e.setter(u,w.popout),e.setter(c,w.params),t.clear&&v!==g&&(a[m].__snapshot=[o],a[m][v]=[o])},_=(r={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e.getter(s),l=e.getter(p),f=a[o][l],y=((e,t)=>{const r=typeof e;if("boolean"===r&&!e)return t.length-2;const o="boolean"===r?Boolean:String;for(let r=t.length-1;r>0;r--)if(o(t[r].stay)===e)return r;return 0})(r.toStay||!1,f);if(1===f.length)return void t.send("VKWebAppClose",{status:"success"});const m=f.at(-1);m&&m.freeze&&!r.ignoreFreeze||(a[o].__snapshot=[{view:l,...f[y]}],e.setter(s,o),e.setter(p,l),e.setter(n,f[y].panel),e.setter(i,f[y].modal),e.setter(u,f[y].popout),e.setter(c,f[y].params),f.splice(y+1))};const d={app:s,view:p,panel:n,modal:i,popout:u};exports.ACTIVE_APP=s,exports.ACTIVE_MODAL=i,exports.ACTIVE_NOTIFY=l,exports.ACTIVE_PANEL=n,exports.ACTIVE_PARAMS=c,exports.ACTIVE_POPOUT=u,exports.ACTIVE_VIEW=p,exports.Router=({app:t="web",branch:o,children:a})=>(e.getter(p)&&e.getter(s)||m({app:t,view:o}),r.useEffect((()=>{window.addEventListener("popstate",(()=>_())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a),exports.backPage=_,exports.hideNotify=function(t){try{const r=e.getter(l);return(!t||r.type===t)&&(e.setter(l,void 0),r.callback({type:r.type,params:r.params}),!0)}catch{return!1}},exports.nextPage=m,exports.showNotify=function(t,r,o,a){return a?function(t,r,o,a){const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}(t,r,o,a):function(t,r,o){return new Promise((a=>{const s=()=>(e.setter(l,void 0),a);e.setter(l,{type:t,params:o,callback:s}),r&&setTimeout((()=>{s()({type:t,params:o})}),r)}))}(t,r,o)},exports.useNotify=()=>{const t=e.useGlobalValue(l);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},exports.useParams=()=>{const[t]=r.useState(e.getter(c));return t},exports.useRouter=t=>{const o=r.useRef(e.getter(s)).current,a=e.useGlobalValue(d[t]),[p,n]=r.useState(a);return r.useEffect((()=>{"app"!==t&&e.getter(s)!==o||n(a)}),[a]),p};
