import{atom as t,getter as e,setter as o,useGlobalValue as a}from"elum-state";import r from"@vkontakte/vk-bridge";import{useState as p,useRef as n,useEffect as s}from"react";const i={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},c={},l=t({key:"router_active_app"}),u=t({key:"router_active_view"}),y=t({key:"router_active_panel"}),m=t({key:"router_active_modal"}),d=t({key:"router_active_popout"}),f=t({key:"router_active_notify"}),_=t({key:"router_active_params"}),v=(t,e)=>Object.keys(t).every((o=>{const a=Object.prototype.toString.call(t[o]);if(a!=Object.prototype.toString.call(e[o]))return!1;switch(a){case"[object String]":case"[object Number]":case"[object Boolean]":return t[o]===e[o];case"[object Object]":case"[object Array]":return v(t[o],e[o]);default:return!1}})),w=["params","popout","modal","panel"],b=t=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=e(l),r=t.app,p=r||a,n=!(!r||r===a),s=c[p]?.__snapshot,f=n&&Array.isArray(s)?s[0].view:e(u),b=t.view||f;!c[p]?.[b]&&(c[p]||(c[p]={__snapshot:[]}),c[p][b]||(c[p][b]=[i])),Array.isArray(c[p]?.__snapshot)||(c[p].__snapshot=[]);const h=n&&Array.isArray(s)?s[0]:c[p][b].at(-1),k={panel:t.panel||h.panel,modal:t.modal||h.modal,popout:t.popout||h.popout,stay:t.stay||i.stay,freeze:t.freeze||i.freeze,params:t.params||h.params};if(!n)for(let e of w){if(t[e])break;k[e]=i[e]}!v(c[p][b].at(-1)||[],k)&&c[p][b].push(k),c[p].__snapshot=[{view:b,...k}],o(l,p),o(u,b),o(y,k.panel),o(m,k.modal),o(d,k.popout),o(_,k.params),t.clear&&f!==b&&(c[p].__snapshot=[i],c[p][f]=[i])},h=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=e(l),p=e(u),n=c[a][p],s=((t,e)=>{const o=typeof t;if("boolean"===o&&!t)return e.length-2;const a="boolean"===o?Boolean:String;for(let o=e.length-1;o>0;o--)if(a(e[o].stay)===t)return o;return 0})(t.toStay||!1,n);if(1===n.length)return void r.send("VKWebAppClose",{status:"success"});const i=n.at(-1);i&&i.freeze&&!t.ignoreFreeze||(o(l,a),o(u,p),o(y,n[s].panel),o(m,n[s].modal),o(d,n[s].popout),o(_,n[s].params),n.splice(s+1))};function k(t,e,a,r){return r?function(t,e,a,r){const p=()=>(o(f,void 0),r);o(f,{type:t,params:a,callback:p}),e&&setTimeout((()=>{p()({type:t,params:a})}),e)}(t,e,a,r):function(t,e,a){return new Promise((r=>{const p=()=>(o(f,void 0),r);o(f,{type:t,params:a,callback:p}),e&&setTimeout((()=>{p()({type:t,params:a})}),e)}))}(t,e,a)}function g(t){try{const a=e(f);return(!t||a.type===t)&&(o(f,void 0),a.callback({type:a.type,params:a.params}),!0)}catch{return!1}}const j=()=>{const[t]=p(e(_));return t},S={app:l,view:u,panel:y,modal:m,popout:d},A=t=>{const o=n(e(l)).current,r=a(S[t]),[i,c]=p(r);return s((()=>{"app"!==t&&e(l)!==o||c(r)}),[r]),i},z=()=>{const t=a(f);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},O=({app:t="web",branch:o,children:a})=>(e(u)&&e(l)||b({app:t,view:o}),s((()=>{window.addEventListener("popstate",(()=>h())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),a);export{l as ACTIVE_APP,m as ACTIVE_MODAL,f as ACTIVE_NOTIFY,y as ACTIVE_PANEL,_ as ACTIVE_PARAMS,d as ACTIVE_POPOUT,u as ACTIVE_VIEW,O as Router,h as backPage,g as hideNotify,b as nextPage,k as showNotify,z as useNotify,j as useParams,A as useRouter};
