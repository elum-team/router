import{atom as t,getter as e,setter as r,useGlobalValue as o}from"elum-state";import a from"@vkontakte/vk-bridge";import{useState as n,useRef as p,useEffect as s}from"react";const i={panel:"default",modal:void 0,popout:void 0,stay:!1,freeze:!1,params:{}},u={},c=t({key:"router_active_app"}),l=t({key:"router_active_view"}),f=t({key:"router_active_panel"}),y=t({key:"router_active_modal"}),m=t({key:"router_active_popout"}),d=t({key:"router_active_notify"}),v=t({key:"router_active_params"}),_=(t,e,r=[])=>{if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e){if(t.constructor!==e.constructor)return!1;var o,a,n;if(Array.isArray(t)){if((o=t.length)!=e.length)return!1;for(a=o;0!=a--;)if(!_(t[a],e[a]))return!1;return!0}if(t.constructor===RegExp)return t.source===e.source&&t.flags===e.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===e.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===e.toString();if((o=(n=Object.keys(t)).length)!==Object.keys(e).length)return!1;for(a=o;0!=a--;){var p=n[a];if(!r.includes(p)){if(!Object.prototype.hasOwnProperty.call(e,p))return!1;if(!_(t[p],e[p]))return!1}}return!0}return t!=t&&e!=e},h=["popout","modal","panel"],w=(t,o)=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const a=e(c),n=t.app,p=n||a,s=!(!n||n===a),d=u[p]?.__snapshot,w=s&&Array.isArray(d)?d[0].view:e(l),g=t.view||w;!u[p]?.[g]&&(u[p]||(u[p]={__snapshot:[]}),u[p][g]||(u[p][g]=[i])),Array.isArray(u[p]?.__snapshot)||(u[p].__snapshot=[]);const b=s&&Array.isArray(d)?d[0]:u[p][g].at(-1),k={panel:t.panel||b.panel,modal:t.modal||b.modal,popout:t.popout||b.popout,stay:t.stay||i.stay,freeze:t.freeze||i.freeze,params:t.params||b.params};if(!s)for(let e of h){if(t[e])break;k[e]=i[e]}_(u[p][g].at(-1),k,o||[])||u[p][g].push(k),u[p].__snapshot=[{view:g,...k}],r(c,p),r(l,g),r(f,k.panel),r(y,k.modal),r(m,k.popout),r(v,k.params),t.clear&&w!==g&&(u[p].__snapshot=[i],u[p][w]=[i])},g=(t={ignoreFreeze:!1,toStay:!1})=>{"file:"!==window.location.protocol&&window.history.pushState(null,"");const o=e(c),n=e(l),p=u[o][n],s=((t,e)=>{const r=typeof t;if("boolean"===r&&!t)return e.length-2;const o="boolean"===r?Boolean:String;for(let r=e.length-1;r>0;r--)if(o(e[r].stay)===t)return r;return 0})(t.toStay||!1,p);if(1===p.length)return void a.send("VKWebAppClose",{status:"success"});const i=p.at(-1);i&&i.freeze&&!t.ignoreFreeze||(u[o].__snapshot=[{view:n,...p[s]}],r(c,o),r(l,n),r(f,p[s].panel),r(y,p[s].modal),r(m,p[s].popout),r(v,p[s].params),p.splice(s+1))};function b(t,e,o,a){return a?function(t,e,o,a){const n=()=>(r(d,void 0),a);r(d,{type:t,params:o,callback:n}),e&&setTimeout((()=>{n()({type:t,params:o})}),e)}(t,e,o,a):function(t,e,o){return new Promise((a=>{const n=()=>(r(d,void 0),a);r(d,{type:t,params:o,callback:n}),e&&setTimeout((()=>{n()({type:t,params:o})}),e)}))}(t,e,o)}function k(t){try{const o=e(d);return(!t||o.type===t)&&(r(d,void 0),o.callback({type:o.type,params:o.params}),!0)}catch{return!1}}const O=()=>{const[t]=n(e(v));return t},S={app:c,view:l,panel:f,modal:y,popout:m},A=t=>{const r=p(e(c)).current,a=o(S[t]),[i,u]=n(a);return s((()=>{"app"!==t&&e(c)!==r||u(a)}),[a]),i},j=()=>{const t=o(d);return t?{type:t.type,params:t.params}:{type:void 0,params:{}}},z=({app:t="web",branch:r,children:o})=>(e(l)&&e(c)||w({app:t,view:r}),s((()=>{window.addEventListener("popstate",(()=>g())),"file:"!==window.location.protocol&&window.history.pushState(void 0,"")}),[]),o);export{c as ACTIVE_APP,y as ACTIVE_MODAL,d as ACTIVE_NOTIFY,f as ACTIVE_PANEL,v as ACTIVE_PARAMS,m as ACTIVE_POPOUT,l as ACTIVE_VIEW,z as Router,g as backPage,k as hideNotify,w as nextPage,b as showNotify,j as useNotify,O as useParams,A as useRouter};
